<!DOCTYPE html>

<html>
<head>
  <title>pageRender.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="Gruntfile.html">
                Gruntfile.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="moduleRender.html">
                moduleRender.coffee
              </a>
            
              
              <a class="source" href="pageRender.html">
                pageRender.coffee
              </a>
            
              
              <a class="source" href="app.html">
                app.coffee
              </a>
            
              
              <a class="source" href="testmodule.init.html">
                testmodule.init.coffee
              </a>
            
              
              <a class="source" href="base.init.html">
                base.init.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>pageRender.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>q = <span class="built_in">require</span> <span class="string">'q'</span>
_ = <span class="built_in">require</span> <span class="string">'lodash'</span>

ModuleRender = <span class="built_in">require</span> <span class="string">'./moduleRender.coffee'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="pagerender-class">PageRender Class</h2>
<p>Controls the action of attempting to find pages
through request URLs. If it does not find a folder
in the pages folder it will 404, likewise if it does not
find a <code>index</code> or <code>_root/index</code> in the existing folder
it will also return a 404.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">PageRender</span></span>
  <span class="attribute">page</span>: {}
  pr = {}
  req = <span class="literal">undefined</span>
  res = <span class="literal">undefined</span>
  deferred = <span class="literal">undefined</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h3 id="construct-class">Construct Class</h3>
<p>Simply passes this to a that working around
namespace issues with this. Sets the initial
<code>folderPath</code> expectation and calls the next
step in the process.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">constructor</span>: <span class="function"><span class="params">(request, response)</span>-&gt;</span>
    pr = @
    req = request
    res = response

    deferred = q.defer()

    pr.page.folderPath = <span class="string">'./pages'</span> + req.url</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>console.log pr.page</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="keyword">return</span> pr.findFolder()</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h3 id="findfolder">findFolder</h3>
<p>Step 1 in the process checks if the folder exists.
If it does not then no further action required
will result in a 404.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">findFolder</span>:<span class="function"> -&gt;</span>
    fs.exists pr.page.folderPath, <span class="function"><span class="params">(bool)</span> -&gt;</span>
      <span class="keyword">if</span> bool
        pr.getIndex()
      <span class="keyword">else</span>
        pr.noLuck()

    deferred.promise</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h3 id="getindex">getIndex</h3>
<p>This step attempts to identify an index file exists.
If it exists the file is read and passed into the
ModuleRender class to process its modules.
If it does not exist, the request is passed on to check if
there may be a <code>_root</code> folder which is useful for
subsections of the site where other pages may exist.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">getIndex</span>:<span class="function"> -&gt;</span>
    pr.page.indexPath = pr.page.folderPath + <span class="string">'/index.json'</span>

    fs.exists pr.page.indexPath, <span class="function"><span class="params">(bool)</span> -&gt;</span>
      <span class="keyword">if</span> bool
        fs.readFile pr.page.indexPath, <span class="string">"utf-8"</span>, <span class="function"><span class="params">(err, content)</span> -&gt;</span>
          <span class="keyword">if</span>(err)
            deferred.reject <span class="keyword">new</span> Error(error)
          <span class="keyword">else</span>
            q<span class="function"><span class="params">(<span class="keyword">new</span> ModuleRender(JSON.parse content))</span>.<span class="title">then</span> <span class="params">(modules)</span> -&gt;</span>
              deferred.resolve _.extend modules, JSON.parse content
      <span class="keyword">else</span>
        pr.rootFolder()</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h3 id="rootfolder">rootFolder</h3>
<p>At this stage we know the folder exists and that there
is not an index.json there, so now we look for a <code>_root</code>
folder which may contain the page data. If we don’t find
it then we’ll return a 404.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">rootFolder</span>:<span class="function"> -&gt;</span>
    pr.page.folderPath = pr.page.folderPath + <span class="string">'_root'</span>
    pr.page.indexPath = pr.page.folderPath + <span class="string">'/index.json'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>console.log pr.page</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    fs.exists pr.page.indexPath, <span class="function"><span class="params">(bool)</span> -&gt;</span>
      <span class="keyword">if</span> bool
        pr.getIndex()
      <span class="keyword">else</span>
        pr.noLuck()</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h3 id="noluck">noLuck</h3>
<p>We tried our best but… no luck, 404.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">noLuck</span>:<span class="function"> -&gt;</span>
    res.status(<span class="number">404</span>).send(<span class="string">'Page not found'</span>)

module.<span class="built_in">exports</span> = PageRender</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
